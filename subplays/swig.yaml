---
- name: make build dir
  file:
    path: "{{ build_dir }}"
    state: directory

- name: download swig
  get_url:
    url: "http://downloads.sourceforge.net/project/swig/swig/swig-{{ swig_version }}/swig-{{ swig_version }}.tar.gz"
    dest: "{{ build_dir }}/swig-{{ swig_version }}.tar.gz"
    validate_certs: false
    timeout: 30
    thirsty: false
  register: swig_download_result
  until: swig_download_result | succeeded
  retries: 5
  delay: 10

- name: check if swig previously built successfully
  stat:
    path: "{{ build_dir }}/swig-completed"
  register: swig_completed

- block:
  - name: remove any previously unsuccessful swig build attempts
    file:
      path: "{{ build_dir }}/swig-{{ swig_version }}"
      state: absent

  - name: unarchive swig
    unarchive:
      src: "{{ build_dir }}/swig-{{ swig_version }}.tar.gz"
      dest: "{{ build_dir }}"
      creates: "{{ build_dir }}/swig-{{ swig_version }}"
      remote_src: true

  - name: configure swig
    command: "./configure --prefix={{ puppetlabs_build_dir }}"
    args:
      chdir: "{{ build_dir }}/swig-{{ swig_version }}"

  - name: make swig
    command: make
    args:
      chdir: "{{ build_dir }}/swig-{{ swig_version }}"

  - name: make install swig
    command: make install
    args:
      chdir: "{{ build_dir }}/swig-{{ swig_version }}"

  - name: swig build/install completed
    file:
      path: "{{ build_dir }}/swig-completed"
      state: touch

  when: swig_completed.stat.islnk is not defined # block
